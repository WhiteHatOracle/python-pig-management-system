{% extends 'home.html' %}
{% block head %}
    <title>{{ sow.sowID }} - service record</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- styling links -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css' )}}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sow_service_records.css' )}}">
    <!-- javascript links -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/home.js')}}" defer></script>  
    <script type="text/javascript" src="{{ url_for('static', filename='js/sow-service-records.js')}}" defer></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/flash.js')}}" defer></script>
{% endblock %}

{% block content %}
<main>
    <!-- Page Header with Back Button -->
    <div class="page-header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()" aria-label="Go back">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M640-80 240-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
            </button>
            <div class="header-text">
                <h1>Service Records</h1>
                <p class="sow-info">
                    <span class="sow-id">{{ sow.sowID }}</span>
                    <span class="separator">â€¢</span>
                    <span class="dob">DOB: {{ sow.DOB.strftime('%d-%b-%Y') if sow.DOB else sow.DOB }}</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Add Record Form -->
    <div class="form-card">
        <div class="form-card-header">
            <h2>Add New Service Record</h2>
        </div>
        <form class="service-form" method="POST" action="{{ url_for('sow_service_records', sow_id=sow.id) }}">
            {{ form.hidden_tag() }}
            <div class="form-grid">
                <div class="form-group">
                    <label for="boar_used">Boar Used</label>
                    {{ form.boar_used(class="form-input") }}
                </div>
                <div class="form-group">
                    <label for="service_date">Service Date</label>
                    {{ form.service_date(class="form-input", type="date", id="date") }}
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
                    <span>Add Record</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                <li class="flash {{ category|lower }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <!-- Records Table -->
    <div class="table-card">
        <div class="table-header">
            <h2>Service History</h2>
            <span class="record-count">{{ sow.service_records|length }} record(s)</span>
        </div>
        
        <div class="table-wrapper">
            <table class="service-table">
                <thead>
                    <tr>
                        <th class="col-index">#</th>
                        <th>Boar</th>
                        <th>Service Date</th>
                        <th>Checkup</th>
                        <th>Lit Guard 1</th>
                        <th>Feed Up</th>
                        <th>Lit Guard 2</th>
                        <th>Action Date</th>
                        <th>Due Date</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                {% if sow.service_records %}  
                <tbody> 
                    {% for record in sow.service_records %}
                    <tr>
                        <td class="col-index">{{ loop.index }}</td>
                        <td data-label="Boar Used">{{ record.boar_used }}</td>
                        <td data-label="Service Date">{{ record.service_date.strftime('%d-%b-%Y') }}</td>
                        <td data-label="Checkup Date">{{ record.checkup_date.strftime('%d-%b-%Y') }}</td>
                        <td data-label="Litter Guard 1">{{ record.litter_guard1_date.strftime('%d-%b-%Y') }}</td>
                        <td data-label="Feed Up (90 days)">{{ record.feed_up_date.strftime('%d-%b-%Y') }}</td>
                        <td data-label="Litter Guard 2">{{ record.litter_guard2_date.strftime('%d-%b-%Y') }}</td>
                        <td data-label="Action Date">{{ record.action_date.strftime('%d-%b-%Y') }}</td>
                        <td data-label="Due Date" class="due-date">{{ record.due_date.strftime('%d-%b-%Y') }}</td>
                        <td class="col-actions" data-label="Actions">
                            <div class="action-buttons">
                                <form action="{{ url_for('litter_records', service_id=record.id) }}" method="POST">
                                    {{ form.hidden_tag() }}
                                    <button type="submit" class="action-btn view-btn" title="View Details">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="M320-240h320v-80H320v80Zm0-160h320v-80H320v80ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-520v-200H240v640h480v-440H520ZM240-800v200-200 640-640Z"/></svg>
                                        <span>Details</span>
                                    </button>  
                                </form>
                                <span class="action-divider"></span>
                                <form action="{{ url_for('delete_service_record', record_id=record.id) }}" method="POST" onsubmit="return confirmDelete();">                       
                                    {{ form.hidden_tag() }}
                                    <button type="submit" class="action-btn delete-btn" title="Delete Record">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                                        <span>Delete</span>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% else %}
                <tbody>
                    <tr class="empty-row">
                        <td colspan="10">
                            <div class="empty-state">
                                <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="currentColor"><path d="M320-240h320v-80H320v80Zm0-160h320v-80H320v80ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-520v-200H240v640h480v-440H520ZM240-800v200-200 640-640Z"/></svg>
                                <p>No service records found</p>
                                <span>Add a new record using the form above</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
                {% endif %}
            </table>
        </div>
    </div>
</main>

<script>
    flatpickr("#date", {
        dateFormat: "d-m-Y",
        maxDate: "today"
    });    
</script>
{% endblock %}