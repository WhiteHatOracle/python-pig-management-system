{% extends "home.html" %}
{% block head %}
    <title>Invoices</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- styling links -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/invoices.css') }}">
    <!-- javascript links -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/home.js') }}" defer></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/invoices.js') }}" defer></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/flash.js')}}" defer></script>  
{% endblock %}

{% block content %}
<main>
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 -960 960 960" width="28px" fill="currentColor"><path d="M280-600v-80h400v80H280Zm0 160v-80h400v80H280Zm0 160v-80h400v80H280Zm-80 200q-33 0-56.5-23.5T120-160v-640q0-33 23.5-56.5T200-880h560q33 0 56.5 23.5T840-800v640q0 33-23.5 56.5T760-80H200Z"/></svg>
            </div>
            <div class="header-text">
                <h1>Invoice History</h1>
                <p>View and manage all generated invoices</p>
            </div>
        </div>
    </div>

    <!-- Invoice Navigation Tabs -->
    <div class="invoice-tabs">
        <a href="{{ url_for('invoice_Generator') }}" class="invoice-tab">
            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
            <span>Generate Invoice</span>
        </a>
        <a href="{{ url_for('invoices') }}" class="invoice-tab active">
            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M280-600v-80h400v80H280Zm0 160v-80h400v80H280Zm0 160v-80h400v80H280Zm-80 200q-33 0-56.5-23.5T120-160v-640q0-33 23.5-56.5T200-880h560q33 0 56.5 23.5T840-800v640q0 33-23.5 56.5T760-80H200Z"/></svg>
            <span>View Invoices</span>
        </a>
    </div>

    <!-- Summary Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon pigs">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Z"/></svg>
            </div>
            <div class="stat-details">
                <span class="stat-value" id="totalPigs">--</span>
                <span class="stat-label">Total Pigs Sold</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon weight">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>
            </div>
            <div class="stat-details">
                <span class="stat-value" id="totalWeight">--</span>
                <span class="stat-label">Total Weight (Kg)</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon average">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M120-240v-80h200v80H120Zm0-200v-80h400v80H120Zm0-200v-80h720v80H120Z"/></svg>
            </div>
            <div class="stat-details">
                <span class="stat-value" id="averageWeight">--</span>
                <span class="stat-label">Average Weight (Kg)</span>
            </div>
        </div>
        <div class="stat-card highlight">
            <div class="stat-icon revenue">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M444-200h70v-50q50-9 86-39t36-89q0-42-24-77t-96-61q-60-20-83-35t-23-41q0-26 18.5-41t53.5-15q32 0 50 15.5t26 38.5l64-26q-11-35-40.5-61T516-710v-50h-70v50q-50 11-78 44t-28 74q0 47 27.5 76t86.5 50q63 23 87.5 41t24.5 47q0 33-23.5 48.5T486-314q-33 0-58.5-20.5T390-396l-66 26q14 48 43.5 77.5T444-252v52Z"/></svg>
            </div>
            <div class="stat-details">
                <span class="stat-value" id="totalRevenue">--</span>
                <span class="stat-label">Total Revenue</span>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="table-controls">
        <div class="search-container">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>
            <input type="text" class="search-input" id="searchInput" placeholder="Search invoices..." onkeyup="filterInvoices()">
            <button type="button" class="clear-search" onclick="clearSearch()">
                <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
            </button>
        </div>
        <div class="table-info">
            <span class="record-count">{{ invoices|length }} invoice(s)</span>
        </div>
    </div>

    <!-- Invoices Table Card -->
    <div class="table-card">
        <div class="table-wrapper">
            <table class="invoices-table" id="invoiceTable">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Company</th>
                        <th>Pigs</th>
                        <th>Date</th>
                        <th>Total Weight</th>
                        <th>Avg Weight</th>
                        <th>Total Price</th>
                        <th class="col-action">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td data-label="Invoice #">
                            <span class="invoice-number">{{ invoice.invoice_number }}</span>
                        </td>
                        <td data-label="Company">{{ invoice.company_name }}</td>
                        <td data-label="Pigs">{{ invoice.num_of_pigs }}</td>
                        <td data-label="Date">{{ invoice.date.strftime('%d-%b-%Y') }}</td>
                        <td data-label="Total Weight">{{ invoice.total_weight }} kg</td>
                        <td data-label="Avg Weight">{{ invoice.average_weight }} kg</td>
                        <td data-label="Total Price" class="price-cell">K{{ "{:,.2f}".format(invoice.total_price) }}</td>
                        <td class="col-action" data-label="Action">
                            <form action="{{ url_for('delete_invoice', invoice_id=invoice.id) }}" method="POST" onsubmit="return confirmDelete();">
                                <button type="submit" class="action-btn delete-btn" title="Delete Invoice">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                                    <span>Delete</span>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr class="empty-row">
                        <td colspan="8">
                            <div class="empty-state">
                                <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="currentColor"><path d="M240-80q-50 0-85-35t-35-85v-120h120v-560l60 60 60-60 60 60 60-60 60 60 60-60 60 60 60-60 60 60 60-60v680q0 50-35 85t-85 35H240Z"/></svg>
                                <h3>No Invoices Found</h3>
                                <p>Create your first invoice using the generator</p>
                                <a href="{{ url_for('invoice_Generator') }}" class="btn btn-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
                                    <span>Generate Invoice</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="pagination-container">
        {% if pagination.has_prev %}
            <a href="{{ url_for('invoices', page=pagination.prev_num) }}" class="pagination-btn prev">
                <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="M560-240 320-480l240-240 56 56-184 184 184 184-56 56Z"/></svg>
                <span>Previous</span>
            </a>
        {% endif %}
        
        <div class="pagination-pages">
            {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                    <a href="{{ url_for('invoices', page=page_num) }}" class="pagination-btn {% if page_num == pagination.page %}active{% endif %}">{{ page_num }}</a>
                {% else %}
                    <span class="pagination-dots">...</span>
                {% endif %}
            {% endfor %}
        </div>
        
        {% if pagination.has_next %}
            <a href="{{ url_for('invoices', page=pagination.next_num) }}" class="pagination-btn next">
                <span>Next</span>
                <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/></svg>
            </a>
        {% endif %}
    </div>
    {% endif %}
</main>

<script>
    function clearSearch() {
        document.getElementById("searchInput").value = "";
        filterInvoices();
    }
    
    function confirmDelete() {
        return confirm("Are you sure you want to delete this invoice? This action cannot be undone.");
    }

    function fetchTotals() {
        fetch('/invoice_totals')
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalWeight').innerText = data.total_weight;
                document.getElementById('totalRevenue').innerText = data.total_revenue;
                document.getElementById('averageWeight').innerText = data.average_weight;
                document.getElementById('totalPigs').innerText = data.total_pigs;
            })
            .catch(error => console.error('Error fetching totals:', error));
    }

    document.addEventListener('DOMContentLoaded', fetchTotals);
    setInterval(fetchTotals, 30000); // Refresh every 30 seconds
</script>
{% endblock %}