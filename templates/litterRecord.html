{% extends 'home.html' %}
{% block title %}{{ sow.sowID ~ ' - Litter Records' }}{% endblock %}

{% block head %}
    <title>{{ sow.sowID }} - Litter Records</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- styling links -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/litters.css') }}">
    <!-- javascript links -->
    <script type="text/javascript" src="{{ url_for('static', filename='js/home.js')}}" defer></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/litters.js')}}" defer></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/flash.js')}}" defer></script>
{% endblock %}  

{% block content %}
<main>
    <!-- Page Header with Back Button -->
    <div class="page-header">
        <div class="header-content">
            <a href="{{ url_for('sow_service_records', sow_id=sow_id) }}" class="back-btn" aria-label="Go back to service records">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M640-80 240-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
            </a>
            <div class="header-text">
                <h1>Litter Records</h1>
                <p class="record-info">
                    <span class="sow-id">{{ serviceRecord.sow.sowID }}</span>
                    <span class="separator">â€¢</span>
                    <span class="service-date">Service: {{ serviceRecord.service_date.strftime('%d-%b-%Y') }}</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Parent Information Cards -->
    <div class="parent-cards">
        <div class="parent-card sire-card">
            <div class="parent-label">
                <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="M800-800v240h-80v-103L561-505q19 28 29 59.5t10 65.5q0 92-64 156t-156 64q-92 0-156-64t-64-156q0-92 64-156t156-64q33 0 65 9.5t59 29.5l159-159H560v-80h240Z"/></svg>
                <span>Sire</span>
            </div>
            <div class="parent-id">{{ serviceRecord.boar_used or 'Not Recorded' }}</div>
        </div>
        <div class="parent-card dam-card">
            <div class="parent-label">
                <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="M440-120v-80h-80v-80h80v-84q-79-14-129.5-75.5T260-582q0-91 64.5-154.5T480-800q91 0 155.5 63.5T700-582q0 81-50.5 142.5T520-364v84h80v80h-80v80h-80Z"/></svg>
                <span>Dam</span>
            </div>
            <div class="parent-id">{{ serviceRecord.sow.sowID }}</div>
        </div>
    </div>

    <!-- Add Litter Form -->
    {% if not existing_litter %}
    <div class="form-card">
        <div class="form-card-header">
            <h2>Add Litter Record</h2>
        </div>
        <form class="litter-form" method="POST" action="{{ url_for('litter_records', service_id=serviceRecord.id) }}">
            {{ form.hidden_tag() }}
            <div class="form-grid">
                <div class="form-group">
                    <label for="farrowDate">Farrow Date</label>
                    {{ form.farrowDate(class="form-input", type="date", id="date") }}
                </div>
                <div class="form-group">
                    <label for="totalBorn">Total Born</label>
                    {{ form.totalBorn(class="form-input", autocomplete="off", placeholder="Enter total born") }}
                </div>
                <div class="form-group">
                    <label for="bornAlive">Born Alive</label>
                    {{ form.bornAlive(class="form-input", autocomplete="off", placeholder="Enter born alive") }}
                </div>
                <div class="form-group">
                    <label for="stillBorn">Still Born</label>
                    {{ form.stillBorn(class="form-input", autocomplete="off", placeholder="Enter still born") }}
                </div>
                <div class="form-group form-group-full">
                    <label for="weights">Weights (comma separated)</label>
                    {{ form.weights(class="form-input form-textarea", autocomplete="off", placeholder="e.g., 1.2, 1.4, 1.3, 1.5") }}
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
                    <span>Add Litter Record</span>
                </button>
            </div>
        </form>
    </div>
    {% else %}
    <div class="info-banner">
        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-280q17 0 28.5-11.5T520-320v-160q0-17-11.5-28.5T480-520q-17 0-28.5 11.5T440-480v160q0 17 11.5 28.5T480-280Zm0-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>
        <span>A litter record already exists for this service.</span>
    </div>
    {% endif %}

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                <li class="flash {{ category|lower }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <!-- Stage Legend -->
    <div class="legend-card">
        <div class="legend-title">Growth Stages</div>
        <div class="legend-items">
            <div class="legend-item">
                <span class="legend-dot stage-preweaning"></span>
                <span>Pre-weaning</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot stage-weaner"></span>
                <span>Weaners</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot stage-grower"></span>
                <span>Growers</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot stage-finisher"></span>
                <span>Finishers</span>
            </div>
        </div>
    </div>

    <!-- Litter Records Table -->
    <div class="table-card">
        <div class="table-header">
            <h2>Litter History</h2>
            <span class="record-count">{{ litters|length }} record(s)</span>
        </div>
        
        <div class="table-wrapper">
            <table class="litter-table">
                <thead>
                    <tr>
                        <th>Farrow</th>
                        <th>Total</th>
                        <th>Alive</th>
                        <th>Still</th>
                        <th>Avg Wt</th>
                        <th>Iron Inj.</th>
                        <th>Teeth Clip</th>
                        <th>Tail Dock</th>
                        <th>Castration</th>
                        <th>Weaning</th>
                        <th class="col-actions">Action</th>
                    </tr>
                </thead>
                {% if litters %}
                <tbody>
                    {% for litter in litters %}
                    <tr class="stage-row stage-{{ litter.stage }}">
                        <td data-label="Farrow Date">{{ litter.farrowDate.strftime('%d-%b-%Y') }}</td>
                        <td data-label="Total Born">{{ litter.totalBorn }}</td>
                        <td data-label="Born Alive">{{ litter.bornAlive }}</td>
                        <td data-label="Still Born">{{ litter.stillBorn }}</td>
                        <td data-label="Avg Weight">{{ litter.averageWeight }} kg</td>
                        <td data-label="Iron Injection">{{ litter.iron_injection_date.strftime("%d-%b-%Y") }}</td>
                        <td data-label="Teeth Clipping">{{ litter.teeth_clipping_date.strftime("%d-%b-%Y") }}</td>
                        <td data-label="Tail Docking">{{ litter.tail_dorking_date.strftime("%d-%b-%Y") }}</td>
                        <td data-label="Castration">{{ litter.castration_date.strftime("%d-%b-%Y") }}</td>
                        <td data-label="Weaning" class="weaning-date">{{ litter.wean_date.strftime('%d-%b-%Y') }}</td>
                        <td class="col-actions" data-label="Action">
                            <form action="{{ url_for('delete_litter', litter_id=litter.id) }}" method="POST" onsubmit="return confirmDelete();">
                                <button type="submit" class="action-btn delete-btn" title="Delete Record">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                                    <span>Delete</span>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% else %}
                <tbody>
                    <tr class="empty-row">
                        <td colspan="11">
                            <div class="empty-state">
                                <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="currentColor"><path d="M180-120q-24 0-42-18t-18-42v-600q0-24 18-42t42-18h600q24 0 42 18t18 42v600q0 24-18 42t-42 18H180Zm0-60h600v-600H180v600Zm100-100h400v-60H280v60Zm0-160h400v-60H280v60Zm0-160h400v-60H280v60ZM180-180v-600 600Z"/></svg>
                                <p>No litter records found</p>
                                <span>Add a litter record using the form above</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
                {% endif %}
            </table>
        </div>
    </div>
</main>

<script>
    flatpickr("#date", {
        dateFormat: "d-m-Y",
        maxDate: "today"
    });    
</script>
{% endblock %}