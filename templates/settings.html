{% extends "home.html" %}

{% block head %}
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css' )}}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css' )}}">
  <script type="text/javascript" src="{{ url_for('static', filename='js/flash.js')}}" defer></script>  
  <script type="text/javascript" src="{{ url_for('static', filename='js/settings.js')}}" defer></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/home.js')}}" defer></script>
{% endblock %}

{% block content %}
<main class="settings-main">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="32px" viewBox="0 -960 960 960" width="32px" fill="currentColor">
                    <path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"/>
                </svg>
            </div>
            <div class="header-text">
                <h1>Settings</h1>
                <p>Manage your account preferences and security</p>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
            <div class="flash-message flash-{{ category|lower }}">
                <span class="flash-icon">
                    {% if category|lower == 'success' %}
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="m424-296 282-282-56-56-226 226-114-114-56 56 170 170Zm56 216q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>
                    {% elif category|lower == 'error' or category|lower == 'danger' %}
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="m336-280 144-144 144 144 56-56-144-144 144-144-56-56-144 144-144-144-56 56 144 144-144 144 56 56ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>
                    {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M480-280q17 0 28.5-11.5T520-320v-160q0-17-11.5-28.5T480-520q-17 0-28.5 11.5T440-480v160q0 17 11.5 28.5T480-280Zm0-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>
                    {% endif %}
                </span>
                <span class="flash-text">{{ message }}</span>
                <button class="flash-close" onclick="this.parentElement.remove()">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <!-- Settings Sections -->
    <div class="settings-container">
        
        <!-- ============================================
             ACCOUNT SECTION
             ============================================ -->
        <div class="settings-section account-section">
            <div class="section-header">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px" fill="currentColor">
                        <path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Z"/>
                    </svg>
                    Account
                </h2>
                <p>Manage your profile and farm information</p>
            </div>
            
            <!-- Account Card -->
            <div class="account-card">
                <a href="{{ url_for('account.profile') }}" class="account-card-link">
                    <div class="account-card-left">
                        <div class="account-avatar">
                            {% if current_user.profile_picture %}
                                <img src="{{ url_for('static', filename='uploads/profile_pictures/' + current_user.profile_picture) }}" 
                                     alt="Profile Picture"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="default-avatar" style="display: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                                        <path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Z"/>
                                    </svg>
                                </div>
                            {% else %}
                                <div class="default-avatar">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
                                        <path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Z"/>
                                    </svg>
                                </div>
                            {% endif %}
                        </div>
                        <div class="account-info">
                            <span class="account-name">{{ current_user.full_name }}</span>
                            <span class="account-email">{{ current_user.email }}</span>
                            {% if current_user.farm_name %}
                            <span class="account-farm">
                                <svg xmlns="http://www.w3.org/2000/svg" height="14px" viewBox="0 -960 960 960" width="14px" fill="currentColor">
                                    <path d="M160-120v-480l320-240 320 240v480H560v-280H400v280H160Z"/>
                                </svg>
                                {{ current_user.farm_name }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="account-card-right">
                        <span class="manage-label">Manage</span>
                        <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
                            <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/>
                        </svg>
                    </div>
                </a>
                
                <!-- Profile Completion -->
                {% set completion = current_user.profile_completion %}
                {% if completion < 100 %}
                <div class="profile-completion-bar">
                    <div class="completion-header">
                        <svg xmlns="http://www.w3.org/2000/svg" height="16px" viewBox="0 -960 960 960" width="16px" fill="currentColor">
                            <path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/>
                        </svg>
                        <span>Complete your profile</span>
                        <span class="completion-percentage">{{ completion }}%</span>
                    </div>
                    <div class="completion-track">
                        <div class="completion-fill" style="width: {{ completion }}%"></div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Quick Actions -->
            <ul class="settings-list">
                <li class="settings-item">
                    <a href="{{ url_for('account.edit_profile') }}">
                        <div class="item-content">
                            <div class="item-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                                    <path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Z"/>
                                </svg>
                            </div>
                            <div class="item-details">
                                <span class="item-title">Edit Profile</span>
                                <span class="item-description">Update your name, email, and phone number</span>
                            </div>
                        </div>
                        <div class="item-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
                                <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/>
                            </svg>
                        </div>
                    </a>
                </li>
                <li class="settings-item">
                    <a href="{{ url_for('account.edit_farm') }}">
                        <div class="item-content">
                            <div class="item-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                                    <path d="M160-120v-480l320-240 320 240v480H560v-280H400v280H160Z"/>
                                </svg>
                            </div>
                            <div class="item-details">
                                <span class="item-title">Farm Information</span>
                                <span class="item-description">Update farm name, address, and logo for invoices</span>
                            </div>
                        </div>
                        <div class="item-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
                                <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/>
                            </svg>
                        </div>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Security Section -->
        <div class="settings-section">
            <div class="section-header">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px" fill="currentColor">
                        <path d="M480-80q-139-35-229.5-159.5T160-516v-244l320-120 320 120v244q0 152-90.5 276.5T480-80Zm0-84q104-33 172-132t68-220v-189l-240-90-240 90v189q0 121 68 220t172 132Zm0-316Z"/>
                    </svg>
                    Security
                </h2>
                <p>Manage your account security</p>
            </div>
            
            <ul class="settings-list">
                <li class="settings-item">
                    <a href="{{ url_for('change_password') }}">
                        <div class="item-content">
                            <div class="item-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                                    <path d="M240-80q-33 0-56.5-23.5T160-160v-400q0-33 23.5-56.5T240-640h40v-80q0-83 58.5-141.5T480-920q83 0 141.5 58.5T680-720v80h40q33 0 56.5 23.5T800-560v400q0 33-23.5 56.5T720-80H240Zm240-200q33 0 56.5-23.5T560-360q0-33-23.5-56.5T480-440q-33 0-56.5 23.5T400-360q0 33 23.5 56.5T480-280ZM360-640h240v-80q0-50-35-85t-85-35q-50 0-85 35t-35 85v80Z"/>
                                </svg>
                            </div>
                            <div class="item-details">
                                <span class="item-title">Change Password</span>
                                <span class="item-description">Update your account password</span>
                            </div>
                        </div>
                        <div class="item-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
                                <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/>
                            </svg>
                        </div>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Appearance Section -->
        <div class="settings-section">
            <div class="section-header">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px" fill="currentColor">
                        <path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q54 0 104-17.5t92-50.5L228-676q-33 42-50.5 92T160-480q0 134 93 227t227 93Z"/>
                    </svg>
                    Appearance
                </h2>
                <p>Customize your app experience</p>
            </div>
            
            <ul class="settings-list">
                <!-- FIXED: Theme Toggle Item -->
                <li class="settings-item settings-item-toggle">
                    <label for="darkModeToggle" class="toggle-item-wrapper">
                        <div class="item-content">
                            <div class="item-icon theme-icon">
                                <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                                    <path d="M480-360q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Zm0 80q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Zm326-268Z"/>
                                </svg>
                                <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                                    <path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Z"/>
                                </svg>
                            </div>
                            <div class="item-details">
                                <span class="item-title">Dark Mode</span>
                                <span class="item-description">Toggle dark/light theme</span>
                            </div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" class="toggle-input">
                            <span class="toggle-label">
                                <span class="toggle-slider"></span>
                            </span>
                        </div>
                    </label>
                </li>
            </ul>
        </div>

        <!-- Danger Zone Section -->
        <div class="settings-section danger-section">
            <div class="section-header">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px" fill="currentColor">
                        <path d="m40-120 440-760 440 760H40Zm138-80h604L480-720 178-200Zm302-40q17 0 28.5-11.5T520-280q0-17-11.5-28.5T480-320q-17 0-28.5 11.5T440-280q0 17 11.5 28.5T480-240Zm-40-120h80v-200h-80v200Zm40-100Z"/>
                    </svg>
                    Danger Zone
                </h2>
                <p>Irreversible account actions</p>
            </div>
            
            <ul class="settings-list">
                <li class="settings-item danger-item">
                    <a href="{{ url_for('delete_account') }}">
                        <div class="item-content">
                            <div class="item-icon danger-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                                    <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
                                </svg>
                            </div>
                            <div class="item-details">
                                <span class="item-title">Delete Account</span>
                                <span class="item-description">Permanently delete your account and all data</span>
                            </div>
                        </div>
                        <div class="item-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
                                <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/>
                            </svg>
                        </div>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- App Info Footer -->
    <div class="app-info">
        <div class="info-content">
            <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor">
                <path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/>
            </svg>
            <span>Farmigo v1.0.0</span>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const darkModeToggle = document.getElementById('darkModeToggle');
    
    // Check current theme from localStorage or body class
    const isDarkMode = document.body.classList.contains('dark-mode') || 
                       localStorage.getItem('darkMode') === 'true';
    
    if (darkModeToggle) {
        // Set initial state
        darkModeToggle.checked = isDarkMode;
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
        }
        
        // Handle toggle change
        darkModeToggle.addEventListener('change', function() {
            document.body.classList.toggle('dark-mode', this.checked);
            localStorage.setItem('darkMode', this.checked);
        });
    }
});
</script>
{% endblock %}